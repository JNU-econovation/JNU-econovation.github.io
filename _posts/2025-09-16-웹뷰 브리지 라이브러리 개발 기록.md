---
layout: post
title: ì›¹ë·° ë¸Œë¦¬ì§€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°œë°œ ê¸°ë¡
subtitle: ì›¹ë·° ë¸Œë¦¬ì§€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°œë°œ ê¸°ë¡ì…ë‹ˆë‹¤. ì›¹ë·°ì™€ ë„¤ì´í‹°ë¸Œ ì•± ê°„ì˜ í†µì‹ ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ê°œë°œí•˜ë©° ê²ªì€ ë¬¸ì œì™€ í•´ê²° ê³¼ì •ì„ ê³µìœ í•©ë‹ˆë‹¤.
author: westzeroright
categories: TECH
banner:
  image: https://velog.velcdn.com/images/dubu1001/post/33cd9818-804e-4b83-a65a-8f3b90fc884c/image.png
tags: TECH
sidebar: []
---

# ì›¹ë·° ë¸Œë¦¬ì§€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°œë°œ ê¸°ë¡

![ì‹œì‘](https://velog.velcdn.com/images/dubu1001/post/33cd9818-804e-4b83-a65a-8f3b90fc884c/image.png)

# ë°°ê²½
ì•ˆë…•í•˜ì‹­ë‹ˆê¹Œ? ì €ëŠ” ì—ì½”ë…¸ë² ì´ì…˜ 26ê¸° ë°•ê±´ê·œì…ë‹ˆë‹¤. ì €ëŠ” 25ë…„ë„ ìƒë°˜ê¸° í”„ë¡œì íŠ¸ë¡œ ì•ˆì „í•œ ì‚°í–‰ì„ ìœ„í•œ ì•±, ì‚°ê²° ì–´í”Œì˜ í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì„ ì§„í–‰í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ ê³¼ì •ì—ì„œ ë‹¨ í•œë²ˆë„ í•´ë³´ì§€ ëª»í–ˆë˜ ì•± ê°œë°œì„ ì§„í–‰í•´ì•¼ë§Œ í–ˆê³ , ì¹œìˆ™í•œ ë¦¬ì•¡íŠ¸ ë¬¸ë²•ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë¦¬ì•¡íŠ¸ ë„¤ì´í‹°ë¸Œë¥¼ ì„ íƒí•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ë¹ ë¥¸ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸ ì§„í–‰ì„ ìœ„í•´ì„œ í™”ë©´ ëŒ€ë¶€ë¶„ì„ ì›¹ë·°ë¥¼ í†µí•´ êµ¬í˜„í•˜ê¸°ë¡œ í•˜ì˜€ìŠµë‹ˆë‹¤. 

> **[í”„ë¡œì íŠ¸ ì‚°ê²°ì„ ì†Œê°œí•©ë‹ˆë‹¤! ğŸ™‹]** <br>
> ì—¬ëŸ¬ë¶„ë“¤ì€ ë“±ì‚°ì„ ì¢‹ì•„í•˜ì‹œë‚˜ìš” ğŸ™‚ ë§ì€ 2~30ëŒ€ ë¶„ë“¤ì€ ë“±ì‚° ë¹„ìœ¨ì´ ë†’ì§€ ì•Šì§€ë§Œ, ì‚¬ê³  ë¹„ìœ¨ì€ ë‹¤ë¥¸ ì—°ë ¹ëŒ€ì— ë¹„í•´ì„œ ê°€ì¥ ë†’ë‹¤ëŠ” ì‚¬ì‹¤ ì•Œê³ ê³„ì‹ ê°€ìš”? ì €í¬ëŠ” ì´ ë¬¸ì œì ì— ì£¼ëª©í•˜ì—¬, ë“±ì‚°ì„ ì¦ê²ê²Œ í•  ìˆ˜ ìˆë„ë¡ í•˜ë©´ì„œ ë“±ì‚° ê³¼ì •ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì‚¬ê³  ì˜ˆë°©, ê°ì§€ ë° êµ¬ì¡° ìš”ì²­ì„ ë•ëŠ” ì•±, ì‚°ê²°ì„ ê°œë°œí•˜ê³  ìˆìŠµë‹ˆë‹¤! <br>
> [ì•± ê¹ƒí—ˆë¸Œ ë§í¬]:(https://github.com/JNU-econovation/Soop-APP) <br>
> [ì›¹ ê¹ƒí—ˆë¸Œ ë§í¬]:(https://github.com/JNU-econovation/Soop-WEB) <br>
> í˜„ì¬ëŠ” ì•±ê³¼ ì›¹ì„ [ëª¨ë…¸ë ˆí¬](https://github.com/JNU-econovation/Sangyeol-FE)ë¡œ ê´€ë¦¬í•˜ê³ ìˆìŠµë‹ˆë‹¤! <br>


# ì›¹ë·°ì™€ ë„¤ì´í‹°ë¸Œ ì•± ê°„ì˜ í†µì‹ 

ìš°ì„  ì›¹ë·°ë¥¼ ë„ìš°ê¸° ìœ„í•´ì„œëŠ” [Webview ë¼ì´ë¸ŒëŸ¬ë¦¬](https://github.com/react-native-webview/react-native-webview)ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ ê°€ì¥ ëŒ€ì¤‘ì ì…ë‹ˆë‹¤. 

ì›¹ë·°ë¥¼ ì‚¬ìš©í•  ë•Œì—ëŠ” Webview ì»´í¬ë„ŒíŠ¸ì— ë³´ì—¬ì£¼ê³  ì‹¶ì€ ì›¹ì˜ ì£¼ì†Œë¥¼ sourceë¡œ ë„˜ê²¨ì£¼ì‹œë©´ ë©ë‹ˆë‹¤. 

![ì›¹ë·°ë€?](https://github.com/geongyu09/geongyu09.github.io/blob/dev/public/assets/blog/webviewThreeWayHandshake/%EC%9B%B9%EB%B7%B0%EB%9E%80.png?raw=true)

JSëŠ” ì›¹ê³¼ ì•± ë‘ í™˜ê²½ì—ì„œ ëŒì•„ê°€ì§€ë§Œ, ê²°êµ­ í•˜ë‚˜ì˜ ì„œë¹„ìŠ¤ë¥¼ ì´ë£¨ê²Œ ë©ë‹ˆë‹¤. ì´ì— ë”°ë¼ì„œ í•˜ë‚˜ì˜ í†µì¼ëœ ì‚¬ìš©ì ê²½í—˜ì„ ì£¼ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ì›¹ê³¼ ì•±ì€ ì„œë¡œ í•„ìš”í•œ ì •ë³´ë“¤ì„ ì†Œí†µí•´ì•¼ í•˜ëŠ” ìƒí™©ë“¤ì´ ë§ì´ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤. ì›¹ë·°ì™€ ë„¤ì´í‹°ë¸Œ ì•± ê°„ì˜ í†µì‹ ì„ ìœ„í•´ì„œëŠ” ì•„ë˜ì™€ ê°™ì€ ë°©ì‹ì„ ì‚¬ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ë„¤ì´í‹°ë¸Œ ì•±ì—ì„œ ì›¹ë·°ë¡œ ë©”ì‹œì§€ ë³´ë‚´ê¸°

ë„¤ì´í‹°ë¸Œ ì•±ì—ì„œ ì›¹ë·°ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë ¤ë©´ `WebView` ì»´í¬ë„ŒíŠ¸ì˜ `postMessage` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë©”ì„œë“œëŠ” ì›¹ë·° ë‚´ì˜ JavaScript ì½”ë“œë¡œ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë„¤ì´í‹°ë¸Œ ì•±ì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<pre>
  <code class="jsx">
    import React from 'react';
    import { WebView } from 'react-native-webview'; 
    import { View, Button } from 'react-native';

    const MyWebView = () => {
      const webviewRef = React.useRef(null);

      const sendMessageToWebView = () => {
        if (webviewRef.current) {
          webviewRef.current.postMessage('Hello from Native App!');
        }
      };

      return (
        <View style={{ flex: 1 }}>
          <WebView
            ref={webviewRef}
            source={{ uri: 'https://example.com' }}
          />
          <Button title="Send Message to WebView" onPress={sendMessageToWebView} />
        </View>
      );
    };
    export default MyWebView;
  </code>
</pre>

ì´ë ‡ê²Œ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ì›¹ ë‚´ì—ì„œ `window.ReactNativeWebView.postMessage`ë¥¼ í†µí•´ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

<pre>
  <code class="jsx">
    // ì›¹ ë‚´ì—ì„œ ë©”ì‹œì§€ ë°›ê¸°
    window.addEventListener('message', (event) => {
      console.log('Received message from Native App:', event.data);
    });
  </code>
</pre>

![ì•±ì—ì„œ ì›¹ìœ¼ë¡œ ë³´ë‚´ê¸°](https://github.com/geongyu09/geongyu09.github.io/blob/dev/public/assets/blog/webviewThreeWayHandshake/appToWeb.png?raw=true)

ë°˜ëŒ€ë¡œ ì›¹ì—ì„œ ë„¤ì´í‹°ë¸Œ ì•±ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ê²½ìš°ëŠ” postMessageë¥¼ ì‚¬ìš©í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

<pre>
  <code class="jsx">
    window.ReactNativeWebView.postMessage('Hello from Web!');
  </code>
</pre>

ì•±ì—ì„œëŠ” ì´ë¥¼ Webviewì˜ `onMessage` ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ í†µí•´ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<pre>
  <code class="jsx">
    <WebView
      ref={webViewRef}
      source={{ uri: 'https://example.com' }}
      onMessage={(event) => {
        console.log('Received message from WebView:', event.nativeEvent.data);
      }}
  </code>
</pre>

![ì›¹ì—ì„œ ì•±ìœ¼ë¡œ ë³´ë‚´ê¸°](https://github.com/geongyu09/geongyu09.github.io/blob/dev/public/assets/blog/webviewThreeWayHandshake/webToApp.png?raw=true)

ì›¹ê³¼ ì•±ì´ ì„œë¡œ ë©”ì‹œì§€ë¥¼ ì£¼ê³  ë°›ëŠ” ê²ƒì€ ì •ë§ ì½”ë“œ ëª‡ ì¤„ë¡œ ê°„ë‹¨íˆ êµ¬í˜„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë‹¤ë§Œ ì´ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•  ìˆ˜ëŠ” ì—†ì—ˆëŠ”ë°ìš”. ì‹¤ì œ ì„œë¹„ìŠ¤ë¥¼ ê°œë°œí•˜ë‹¤ë³´ë©´ ì´ë³´ë‹¤ í›¨ì”¬ ë§ì€ ê²½ìš°ë¥¼ ê³ ë ¤í•´ì•¼ë§Œ í•©ë‹ˆë‹¤.! 

# ê¸°ì¡´ ì´ë²¤íŠ¸ ê¸°ë°˜ í†µì‹ ì˜ ë¬¸ì œì ë“¤

ì•„ì§ ì•± ê°œë°œì„ ë§ì´ í•´ë³´ì§€ ì•Šì€ ì§§ì€ ì‹ê²¬ìœ¼ë¡œ ìƒê°í•œ ë¬¸ì œì ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

1. ì›¹ê³¼ ì•± ê°„ì˜ ë©”ì‹œì§€ í˜•ì‹ì„ ì •í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤.

2. ì´ë²¤íŠ¸ ê¸°ë°˜ ì½”ë“œë“¤ì€ ì „ë¶€ ë¦¬ì•¡íŠ¸ì™€ ìƒëª… ì£¼ê¸°ê°€ ë§ì§€ ì•ŠëŠ” ì‚¬ì´ë“œ ì´íŒ©íŠ¸ë“¤ì…ë‹ˆë‹¤. 

3. ì•±ì—ì„œ ì›¹ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ê²½ìš°, ì›¹ì´ ë¡œë”©ë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë©´ ë©”ì‹œì§€ë¥¼ ë°›ì§€ ëª»í•˜ê²Œ ë©ë‹ˆë‹¤. 

4. ì„œë¡œê°„ì˜ í†µì‹ ì—ì„œ responseê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ ì „ë‹¬ì´ ì˜¬ë°”ë¥´ê²Œ ë˜ì—ˆëŠ”ì§€, í˜¹ì€ ì—ëŸ¬ê°€ ë°œìƒí–ˆëŠ”ì§€ë¥¼ ì•Œ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. 

ë¶„ëª…íˆ ì €ë¿ë§Œ ì•„ë‹ˆë¼ ë‹¤ë¥¸ ê°œë°œìë¶„ë“¤ë„ ë™ì¼í•˜ê²Œ ëŠê¼ˆì„ ê²ƒì´ë¼ ìƒê°í•©ë‹ˆë‹¤. ê·¸ëŸ¬í•˜ì—¬ ë‹¤ì–‘í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ì•„ë³´ì•˜ëŠ”ë°, ìƒê°ë³´ë‹¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë§ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì •ë§ ì˜ ë§Œë“¤ì–´ì§„ [FE conf ì—ì„œ ë°œí‘œëœ ë¼ì´ë¸ŒëŸ¬ë¦¬](https://github.com/gronxb/webview-bridge)ê°€ ìˆì—ˆì§€ë§Œ, ì•±ì„ ì²˜ìŒ ê°œë°œí•˜ëŠ” ì €ì˜ ì…ì¥ì—ì„œëŠ” ê°€ë³ê²Œ ì œê²Œ í•„ìš”í•œ ê¸°ëŠ¥ë§Œì„ ì œê³µí•˜ëŠ” ì €ë§Œì˜ ì½”ë“œê°€ ìˆê¸°ë¥¼ ë°”ëìŠµë‹ˆë‹¤. ê·¸ë¦¬í•˜ì—¬ ì§ì ‘ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ê°œë°œí•˜ê¸°ë¡œ í•˜ì˜€ìŠµë‹ˆë‹¤.

(ìƒˆë¡œìš´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë˜ ê³µë¶€í•´ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒë³´ë‹¤ëŠ” ì œê°€ í•„ìš”í•œ ê¸°ëŠ¥ë§Œì„ ê°€ì§„ ê°€ë²¼ìš´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë§Œë“œëŠ” ê²ƒì´ ì‹œê°„ì , ê°œë°œì ìœ¼ë¡œë‚˜ í›¨ì”¬ ë¹„ìš©ì´ ì ê²Œ ë“¤ ê²ƒìœ¼ë¡œ ì˜ˆìƒí•˜ì˜€ìŠµë‹ˆë‹¤!)


# ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°œë°œ

## ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ëª©í‘œ

ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ëª©í‘œëŠ” ì›¹ê³¼ ë„¤ì´í‹°ë¸Œ ì•± ê°„ì˜ í†µì‹  ë¡œì§ì„ ê°„ë‹¨í•˜ê²Œ ì‘ì„±í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ê²ƒì…ë‹ˆë‹¤.ì´ë¥¼ ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ê¸°ëŠ¥ì„ ì œê³µí•˜ê³ ì í•©ë‹ˆë‹¤.

1. **ë©”ì‹œì§€ íƒ€ì… ì •ì˜**: ì›¹ê³¼ ì•± ê°„ì˜ ë©”ì‹œì§€ íƒ€ì…ì„ ì •ì˜í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ì •í•œ íƒ€ì…ì„ í†µí•˜ì—¬ ë©”ì‹œì§€ì˜ í˜•ì‹ì„ ì¼ê´€ë˜ê³ , íƒ€ì… ì„¸ì´í”„í•˜ê²Œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   
2. **ë¦¬ì•¡íŠ¸ í›… ì‚¬ìš©**: ë¦¬ì•¡íŠ¸ í›…ì„ ì‚¬ìš©í•˜ì—¬ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³  ë°›ì„ ìˆ˜ ìˆëŠ” ê°„ë‹¨í•œ APIë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ê°œë°œìëŠ” ë³µì¡í•œ ì‚¬ì´ë“œ ì´íŒ©íŠ¸ ê´€ë¦¬ ì—†ì´ ë©”ì‹œì§€ë¥¼ ì£¼ê³  ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   
3. **ì‘ë‹µ ì²˜ë¦¬**: ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ í›„ ì‘ë‹µì„ ë°›ì„ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë©”ì‹œì§€ê°€ ì˜¬ë°”ë¥´ê²Œ ì „ë‹¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   
4. **ì—ëŸ¬ ì²˜ë¦¬**: ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì—ëŸ¬ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ê°œë°œìëŠ” ì—ëŸ¬ ìƒí™©ì„ ì‰½ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   
5. **í†µì‹  ê°€ëŠ¥ ì‹œì  ê´€ë¦¬**: ì›¹ì´ ë¡œë”©ëœ í›„ì—ë§Œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆë„ë¡ ê´€ë¦¬í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì›¹ì´ ë¡œë”©ë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìœ„ì˜ ëª©í‘œë“¤ì€ í”íˆ ì›¹ì—ì„œ ìƒê°í•  ìˆ˜ ìˆëŠ” HTTP í†µì‹ ê³¼ ìœ ì‚¬í•©ë‹ˆë‹¤. ê·¸ë˜ì„œ ì´ë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œëŠ” HTTP í†µì‹ ì„ êµ¬í˜„í•˜ëŠ” ê²ƒê³¼ ìœ ì‚¬í•œ ë°©ì‹ìœ¼ë¡œ ê°œë°œí•˜ë©´ ë  ê²ƒì´ë¼ ìƒê°í–ˆìŠµë‹ˆë‹¤.


## í†µì‹  ê°€ëŠ¥ ì‹œì  í™•ì¸í•˜ê¸°

### í•´ê²°í•´ì•¼í•˜ëŠ” ë¬¸ì œ ìƒí™©

ê°œë°œí•˜ë‹¤ë³´ë©´ ì›¹ì„ ë„ìš°ìë§ˆì íŠ¹ì • ë™ì‘ì„ í•´ì•¼í•˜ëŠ” ê²½ìš°ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ë¿ë§Œ ì•„ë‹ˆë¼ ì–´ëŠ ì‹œì ë¶€í„° ì›¹ê³¼ ì•± ê°„ì˜ í†µì‹ ì´ ê°€ëŠ¥í•œì§€ í™•ì¸í•´ì•¼ë§Œ ì•ˆì •ì ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ì£¼ê³  ë°›ì„ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤. 

ì²˜ìŒì—ëŠ” ë‹¨ìˆœíˆ ì›¹ë·°ê°€ ë¡œë”©ëœ í›„(Webview ì»´í¬ë„ŒíŠ¸ì˜ onLoad ì‚¬ìš©)ì—ë§Œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ë°©ë²•ì„ ìƒê°í–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ëŠ” ì›¹ë·°ê°€ ë¡œë“œë˜ì—ˆë‹¤ëŠ” ê²ƒì„ ì•Œë ¤ì¤„ ë¿ ì •ë§ë¡œ ì•±ì—ì„œ ë³´ë‚¸ ë©”ì‹œì§€ë¥¼ ë°›ì„ ìˆ˜ ìˆëŠ” Next.jsì˜ jsê°€ ì˜¬ë°”ë¥´ê²Œ ë¡œë“œë˜ì—ˆëŠ”ì§€ë¥¼ ë‚˜íƒ€ë‚¼ ìˆ˜ëŠ” ì—†ì—ˆìŠµë‹ˆë‹¤. ê·¸ë ‡ê¸°ì— ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ì˜¬ë°”ë¥´ê²Œ ë™ì‘í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 

### ì•„ì´ë””ì–´ : TCP 3-Way-Handshake

ì–´ë–»ê²Œ ì´ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆì„ê¹Œ ê³ ë¯¼í•˜ë‹¤ê°€ TCP í†µì‹ ì„ ìƒê°í•´ë³´ì•˜ìŠµë‹ˆë‹¤.

- í†µì‹ ì„ ì‹œì‘í•˜ëŠ” ì£¼ì²´ê°€ ë¨¼ì € SYN ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ë³´ëƒ…ë‹ˆë‹¤. 
- ìƒëŒ€ë°©ì€ SYN ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ë°›ê³ , SYN/ACK ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
- ë§ˆì§€ë§‰ìœ¼ë¡œ ì£¼ì²´ëŠ” ACK ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ë³´ë‚´ë©° ì—°ê²°ì„ ì™„ë£Œí•©ë‹ˆë‹¤. ì´ë•Œ ACKì™€ ë™ì‹œì— ë°ì´í„°ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

ì´ëŸ¬í•œ 3-Way-Handshake ê³¼ì •ì„ í†µí•´ ê°ì í†µì‹ ì— í•„ìš”í•œ ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

ì´ë¥¼ ì›¹ë·° í†µì‹  ë¡œì§ì— ì ìš©í•´ë³¼ ìˆ˜ ìˆì§€ ì•Šì„ê¹Œìš”?

### ê°œë°œ ê³¼ì •

ì²˜ìŒì—ëŠ” ì›¹ë·°ì— javascriptë¥¼ ì‚½ì…(inject)í•˜ì—¬, ì›¹ë·°ê°€ ë¡œë”©ë˜ë©´ ë°”ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•˜ê³ ì í•˜ì˜€ìŠµë‹ˆë‹¤. 
ì´ë¥¼ í†µí•´ì„œ êµ³ì´ ì›¹ì—ì„œëŠ” ì•±ê³¼ì˜ í†µì‹ ì— ëŒ€í•´ì„œ ì‹ ê²½ì“°ì§€ ì•Šìœ¼ë©°, ì•± ë‚´ì—ì„œë§Œ í†µì‹ ì„ ê´€ë¦¬í•  ìˆ˜ ìˆì„ ê²ƒì´ë¼ ìƒê°í–ˆìŠµë‹ˆë‹¤.

<pre>
  <code class="jsx">
    export const WEB_VIEW_HANDSHAKE = `
    (() => {
      alert('ì›¹ë·° í•¸ë“œì‰ì´í¬ ì‹œì‘');
      const webviewReady = (syn, ack) => window.ReactNativeWebView.postMessage(JSON.stringify({ name: 'webview-handshake', meta: {syn, ack} }));

      webviewReady(1, 0);

      // ë§Œì•½ ì›¹ë·° ìš”ì²­ì„ ë³´ë‚¸ ì´í›„ 1ì´ˆ ì´ë‚´ì— ì‘ë‹µì„ ë°›ì§€ ëª»í•˜ë©´ í•œë²ˆ ë” ìš”ì²­ì„ ë³´ë‚¸ë‹¤.
      // 1ì´ˆë¡œ í•œ ì´ìœ ëŠ” ì¼ë°˜ì ì¸ ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œì—ì„œ TCP ì—°ê²°ì„ ìœ„í•œ SYN íƒ€ì„ì•„ì›ƒì´ 1ì´ˆë¡œ ì„¤ì •ë˜ì–´ ìˆê¸° ë•Œë¬¸ì´ë‹¤.
      let timeoutId = setTimeout(() => {
        webviewReady(1, 0);
      }, 1000);

      function handleMessage(event) {
        try {
          const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
          
          if (data.name === 'webview-handshake' && data.meta.syn === 1 && data.meta.ack === 1) {
            webviewReady(0, 1);
            
            if (timeoutId) {
              clearTimeout(timeoutId);
            }

            window.removeEventListener('message', handleMessage);
          }
        } catch (error) {
          console.error('ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        }
      }
      window.addEventListener('message', handleMessage);
      return true;
    })()
    `;
  </code>
</pre>

í•˜ì§€ë§Œ ì´ ë°©ë²•ì€ ì›¹ë·°ê°€ ë¡œë”©ë˜ê¸° ì „ì— ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ ì›¹ë·°ê°€ ì™„ì „íˆ ë¡œë”©ë˜ì–´ jsê°€ ë™ì‘í•  ìˆ˜ ìˆëŠ” ì‹œì ì„ ì§ì ‘ ì›¹ì—ì„œ ì•Œë ¤ì£¼ë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤. ì›¹ì—ì„œ ì•±ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ë‹¤ëŠ” ê²ƒì€, javascriptê°€ ì™„ì „íˆ ë¡œë”©ë˜ì—ˆë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•˜ë©°, ê·¸ ì‹œì  ì´í›„ë¶€í„°ëŠ” ì•±ìœ¼ë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ë°›ì„ ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. (Nextë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìƒê°í•´ë³´ë©´, hydrationì´ ì™„ë£Œëœ ì´í›„(windowë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì‹œì ë¶€í„°)ë¼ê³  ìƒê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)

HTTPë¡œ ìƒê°í•´ë³´ë©´ ì•±ì€ í•­ìƒ ì‹¤í–‰ë˜ê³  ìˆëŠ” ì„œë²„ì´ê³ , ì›¹ì€ ì¤‘ê°„ì¤‘ê°„ ê°„í—ì ìœ¼ë¡œ ì ‘ì†ì„ í•˜ê³  ëŠê¸°ëŠ” í´ë¼ì´ì–¸íŠ¸ë¼ê³  ìƒê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¦‰ ì–´ì©Œë©´ ì›¹ì´ ë¨¼ì € ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ê²ƒì€ ìì—°ìŠ¤ëŸ¬ìš´ ê²ƒì…ë‹ˆë‹¤.

<pre>
  <code class="jsx">
    // 3-way-handshake ë¡œì§ì´ ì¶”ê°€ëœ Webview ì»´í¬ë„ŒíŠ¸
    const WebViewWithInjected = forwardRef&lt;WebView, WebViewWithInjectedProps&gt;(
      ({ source, onMessage, onReadyToMessage }, ref) =&gt; {
        const [isWebViewReady, setIsWebViewReady] = useState(false);
        const webViewRef = useRef&lt;WebView&gt;(null);

        useImperativeHandle(ref, () =&gt; webViewRef.current as WebView);

        useEffect(() =&gt; {
          if (isWebViewReady) {
            Alert.alert("onReadyToMessage ì‹¤í–‰");
            onReadyToMessage?.();
          }
        }, [isWebViewReady, onReadyToMessage]);

        const handleMessage = useCallback(
          (event: WebViewMessageEvent) =&gt; {
            const reqMessage = JSON.parse(event.nativeEvent.data);
            if (reqMessage.name === "webview-handshake") {
              if (reqMessage.meta.syn === 1 &amp;&amp; reqMessage.meta.ack === 0) {
                webViewRef.current?.postMessage(
                  JSON.stringify({
                    name: "webview-handshake",
                    meta: { syn: 1, ack: 1 },
                  }),
                );
                return;
              }
              if (reqMessage.meta.syn === 0 &amp;&amp; reqMessage.meta.ack === 1) {
                setIsWebViewReady(true);
                Alert.alert("ì›¹ë·° í•¸ë“œì‰ì´í¬ ì™„ë£Œ" + isWebViewReady);
                onReadyToMessage?.();
                return;
              }
            }
            if (onMessage) onMessage(reqMessage);
          },
          [onMessage],
        );

        return (
          &lt;WebView
            source={source}
            ref={webViewRef}
            injectedJavaScript={INJECTED_JAVASCRIPT}
            showsHorizontalScrollIndicator={false}
            onMessage={handleMessage}
          /&gt;
        );
      },
    );

    export default WebViewWithInjected;
  </code>
</pre>

ì•±ì—ì„œëŠ” ì›¹ìœ¼ë¡œë¶€í„° syn ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ë©´ syn/ack ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³ , ack ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ë©´ ì›¹ë·°ê°€ ì¤€ë¹„ë˜ì—ˆë‹¤ëŠ” ê²ƒì„ ì¸ì§€í•©ë‹ˆë‹¤. ì´ ê³¼ì •ì´ ì „ë¶€ ëë‚˜ë©´ ì›¹ë·°ê°€ ì¤€ë¹„ë˜ì—ˆë‹¤ëŠ” ê²ƒì„ ì¸ì§€í•˜ê²Œ ë©ë‹ˆë‹¤. 

ì›¹ì—ì„œëŠ” ì•„ë˜ì²˜ëŸ¼ êµ¬í˜„í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. 

<pre>
  <code class="jsx">
    "use client";

    type Flag = 0 | 1;

    interface WebviewHandshake {
      name: "webview-handshake";
      flag: {
        syn: Flag;
        ack: Flag;
      };
    }

    const TIMEOUT = 1000;

    function postMessage&lt;Data&gt;(
      message: MessageEventResponseData&lt;Data&gt; | WebviewHandshake
    ) {
      window.ReactNativeWebView?.postMessage(JSON.stringify(message));
      document.ReactNativeWebView?.postMessage(JSON.stringify(message));
    }

    export default function Bridge({ onRequest }: BridgeProps) {
      // ...ì•±ì—ì„œ ë³´ë‚¸ ì¼ë°˜ ë©”ì‹œì§€ ì²˜ë¦¬ ì½”ë“œ...

      useEffect(() =&gt; {

        // 0. Bridgeì»´í¬ë„ŒíŠ¸ê°€ ë¡œë“œë˜ê³  jsë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ì‹œì ì—ì„œ, ì•±ìœ¼ë¡œ syn ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ë‹¤. 
        const postHandShakeMessage = (syn: Flag, ack: Flag) =&gt; {
          postMessage({ name: "webview-handshake", flag: { syn, ack } });
        };
        postHandShakeMessage(1, 0);

        // ì•±ìœ¼ë¡œ synì„ ë³´ë‚¸ í›„, 1ì´ˆ ì´ë‚´ì— ackì„ ë°›ì§€ ëª»í•˜ë©´ ë‹¤ì‹œ synì„ ë³´ë‚¸ë‹¤.
        // 1ì´ˆë¡œ ì„¤ì •í•œ ì´ìœ ëŠ” ì¼ë°˜ì ì¸ ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œì—ì„œ TCP ì—°ê²°ì„ ìœ„í•œ SYN íƒ€ì„ì•„ì›ƒì´ 1ì´ˆë¡œ ì„¤ì •ë˜ì–´ ìˆê¸° ë•Œë¬¸ì´ë‹¤.
        const timeoutId = setTimeout(() =&gt; {
          postHandShakeMessage(1, 0);
        }, TIMEOUT);

        const handleMessage = (event: MessageEvent) =&gt; {
          event.stopPropagation();
          try {
            // 3. ì•±ìœ¼ë¡œë¶€í„° ë°›ì€ ë©”ì‹œì§€ì—ì„œ nameê³¼ flagë¥¼ ì¶”ì¶œí•œë‹¤. 
            const {
              name,
              flag: { syn, ack },
            } =
              typeof event.data === "string" ? JSON.parse(event.data) : event.data;

            // 4. í•¸ë“œì…°ì´í¬ ê³¼ì •ì—ì„œ syn/ack ë©”ì‹œì§€ë¥¼ ê¸°ëŒ€í•˜ê³  ìˆìœ¼ë©°, synì´ 1ì´ê³  ackì´ 1ì¸ ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ë©´ ì•±ì—ì„œ ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆë‹¤ëŠ” ê²ƒì„ ì¸ì§€í•œë‹¤.
            // 5. ì´í›„ ackì„ ë³´ë‚´ê³ , íƒ€ì„ì•„ì›ƒ ë° í•¸ë“œì…°ì´í¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì œê±°í•œë‹¤.
            if (name === "webview-handshake" &amp;&amp; syn === 1 &amp;&amp; ack === 1) {
              postHandShakeMessage(0, 1);

              if (timeoutId) clearTimeout(timeoutId);

              window.removeEventListener("message", handleMessage);
            }
          } catch (error) {
            console.error("handshake ì¤‘ ì—ëŸ¬ ë°œìƒ:", error);
            window.removeEventListener("message", handleMessage);
          }
        };

        // 1. ì›¹ë·°ê°€ ë¡œë”©ë˜ë©´ ì•±ìœ¼ë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ë°›ê¸° ìœ„í•´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë“±ë¡í•œë‹¤.
        // 2. ì•±ìœ¼ë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ë©´ handleMessage í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œë‹¤.
        window.addEventListener("message", handleMessage);
      }, []);

      return null;
    }
  </code>
</pre>

ì›¹ì—ì„œëŠ” ìš°ì„ ì ìœ¼ë¡œ ì•±ìœ¼ë¡œ syn ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³ , ì•±ì—ì„œ syn/ack ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ë©´ ack ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ì›¹ë·°ê°€ ë¡œë”©ëœ ì´í›„ì—ë§Œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

ì´ë¥¼ ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ìœ¼ë¡œ ë‚˜íƒ€ë‚´ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

![handshake ë‹¤ì´ì–´ê·¸ë¨](https://github.com/geongyu09/geongyu09.github.io/blob/dev/public/assets/blog/webviewThreeWayHandshake/handshake-process.png?raw=true)

ì‹¤ì œë¡œ ì•„ë˜ì²˜ëŸ¼ ì˜ ë™ì‘í•©ë‹ˆë‹¤!

![handshake ì‹œì—°](https://github.com/geongyu09/geongyu09.github.io/blob/dev/public/assets/blog/webviewThreeWayHandshake/handshake.gif?raw=true)

ê´€ë ¨ëœ prì€ [ì—¬ê¸°](https://github.com/JNU-econovation/Soop-WEB/pull/11)ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

## ë‚˜ë¨¸ì§€ ë¬¸ì œë“¤ í•´ê²°

ì´ì œ ì›¹ë·°ê°€ ë¡œë”©ëœ ì´í›„ì—ë§Œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆê²Œ ë˜ì—ˆìœ¼ë‹ˆ, ë‚˜ë¨¸ì§€ ë¬¸ì œë“¤ì„ í•´ê²°í•´ë³´ê² ìŠµë‹ˆë‹¤. ì•ˆì „í•œ í†µì‹ ì„ ìœ„í•˜ì—¬ í†µì‹  ê°€ëŠ¥ ì‹œì ì„ TCP 3-Way-Handshakeë¡œ í™•ì¸í•˜ëŠ” ê³¼ì •ì„ ê±°ì³¤ìŠµë‹ˆë‹¤. ì´ì œëŠ” ì´ ë©”ì‹œì§€ë¥¼ ì£¼ê³  ë°›ì„ ìˆ˜ ìˆë„ë¡, ì‹¤ì œ HTTP í†µì‹ ì—ì„œ ë©”ì‹œì§€ë¥¼ í•˜ìœ„ ë ˆì´ì–´ì˜ í—¤ë”ë¡œ ê°ì‹¸ ë³´ë‚´ë“¯ì´ ì¸ìë¡œ ì „ë‹¬ë°›ì€ ë©”ì‹œì§€ë¥¼ í—¤ë”ë¡œ ê°ì‹¸ì„œ ë³´ë‚´ë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤. 

![ê°œì„ ëœ ì „ì²´ í†µì‹  ë‹¤ì´ì–´ê·¸ë¨](https://github.com/geongyu09/geongyu09.github.io/blob/dev/public/assets/blog/webviewThreeWayHandshake/improve-handshake.png?raw=true)

### ë°›ì„ ë•Œì—ëŠ” ì»´í¬ë„ŒíŠ¸ë¡œ, ë³´ë‚¼ ë•Œì—ëŠ” í›…ìœ¼ë¡œ

ì›¹ë·°ì™€ ì•± ê°„ì˜ ë©”ì‹œì§€ë¥¼ ì£¼ê³ ë°›ì„ ë•Œ, ë°›ëŠ” ìª½ì€ ì»´í¬ë„ŒíŠ¸ë¡œ, ë³´ë‚´ëŠ” ìª½ì€ í›…ìœ¼ë¡œ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ëŠ” ë¦¬ì•¡íŠ¸ì˜ ì»´í¬ë„ŒíŠ¸ì™€ í›…ì˜ ì‚¬ìš© ë°©ì‹ì„ ë”°ë¥´ë„ë¡ í•˜ì—¬ ê°œë°œìê°€ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤. 

### íƒ€ì… ì•ˆì •ì„±ì„ ì±™ê¸°ì

í”íˆ ê°œë°œìê°€ api ëª…ì„¸ì„œë¥¼ ì‘ì„±í•  ë•Œ ìš”ì²­ê³¼ ì‘ë‹µê°’ì„ íŒ€ì˜ ì·¨í–¥ì— ë§ê²Œ ì •ì˜í•©ë‹ˆë‹¤. ë©”ì‹œì§€ íƒ€ì… ë˜í•œ ì‚¬ìš©í•˜ëŠ” ê³³ì—ì„œ ì§ì ‘ ì •ì˜í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ê²ƒì´ ë§ë‹¤ê³  ìƒê°í•˜ì˜€ìŠµë‹ˆë‹¤. ì •ì˜í•œ íƒ€ì…ì„ ì§€í‚¬ ìˆ˜ ìˆë„ë¡ í•˜ì—¬ íƒ€ì… ì„¸ì´í”„í•œ í†µì‹ ì´ ê°€ëŠ¥í•˜ê²Œ í•˜ê³ ì í•˜ì˜€ìŠµë‹ˆë‹¤. 

ì›¹ì˜ ê²½ìš° ì•„ë˜ì²˜ëŸ¼ ì‚¬ìš©í•˜ë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤.

<pre>
  <code class="jsx">
    // ì›¹ì—ì„œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ë•Œ

    // ìš”ì²­/ì‘ë‹µ ë©”ì‹œì§€ íƒ€ì…ì„ ë„£ì–´ ì •ì˜í•œë‹¤.
    const { request } = useBridge<RequestMessage, ResponseMessage>();

    const sendMessage = () => {
      request({
        requestMessage: {
          // ì „ì†¡í•  ìš”ì²­ ë©”ì‹œì§€
          // ì´ì „ì— ì •ì˜í•œ ë©”ì‹œì§€ íƒ€ì…ì„ ë”°ë¥¼ ìˆ˜ ìˆë„ë¡ ìœ ë„í•œë‹¤.
        },
        responseCallback: (response) => {
          // ì‘ë‹µ ë©”ì‹œì§€ê°€ ì™”ì„ ë•Œ ì²˜ë¦¬í•˜ëŠ” ì½œë°±
          // responseëŠ” ì´ì „ì— ì •ì˜í•œ ì‘ë‹µ ë©”ì‹œì§€ íƒ€ì…ì„ ë”°ë¥¸ë‹¤.
        },
        onErrorCallback: (error) => {
          // ì—ëŸ¬ê°€ ë°œìƒí–ˆì„ ë•Œ ì²˜ë¦¬í•˜ëŠ” ì½œë°±
        },
      });
    };
  </code>
</pre>

- useBridge í›…ì„ í†µí•´ì„œ ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆëŠ” í•¨ìˆ˜ë¥¼ ì–»ì–´ì˜¤ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- useBridge í›…ì— ìš”ì²­ê³¼ ì‘ë‹µ ë©”ì‹œì§€ íƒ€ì…ì„ ì œë„¤ë¦­ìœ¼ë¡œ ë„˜ê²¨ì£¼ì–´, ìš”ì²­ê³¼ ì‘ë‹µ ë©”ì‹œì§€ì˜ íƒ€ì…ì„ ë¯¸ë¦¬ ì •ì˜í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- request í•¨ìˆ˜ì˜ ê²½ìš° ë³´ë‚¼ ìš”ì²­ ë©”ì‹œì§€ì™€, ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ë°›ì•˜ì„ ë•Œ í˜¸ì¶œí•  ì½œë°±, ì—ëŸ¬ê°€ ë°œìƒí–ˆì„ ë•Œ í˜¸ì¶œí•  ì½œë°±ì„ ì¸ìë¡œ ë°›ìŠµë‹ˆë‹¤. ê°ê°ì€ ì´ì „ì— ì •ì˜í•œ ë©”ì‹œì§€ íƒ€ì…ì„ ë”°ë¦…ë‹ˆë‹¤.


<pre>
  <code class="jsx">
    // ì›¹ì—ì„œ ë©”ì‹œì§€ë¥¼ ë°›ì„ ë•Œ
    <BridgeRequestListener<RequestMessage, ResponseMessage>
      onRequest={(requestMessage) => {
        // requestMessageëŠ” ì´ì „ì— ì •ì˜í•œ ìš”ì²­ ë©”ì‹œì§€ íƒ€ì…ì„ ë”°ë¥¸ë‹¤.
        if (/*requestMessage ê´€ë ¨ ë¶„ê¸° ì²˜ë¦¬*/)
          return {
            // ì‘ë‹µ ë©”ì‹œì§€
          } 
        return {
          // ì˜ˆìƒí•˜ì§€ ëª»í•œ ìš”ì²­ì´ ì™”ì„ ë•Œì˜ ì‘ë‹µ ë©”ì‹œì§€
        };
      }}
    />
  </code>
</pre>

- BridgeRequestListener ì»´í¬ë„ŒíŠ¸ì— ìš”ì²­ê³¼ ì‘ë‹µ ë©”ì‹œì§€ íƒ€ì…ì„ ì œë„¤ë¦­ìœ¼ë¡œ ë„˜ê²¨ì£¼ì–´, ìš”ì²­ê³¼ ì‘ë‹µ ë©”ì‹œì§€ì˜ íƒ€ì…ì„ ë¯¸ë¦¬ ì •ì˜í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- onRequest ì½œë°±ì„ í†µí•´ì„œ ìš”ì²­ ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìš”ì²­ ë©”ì‹œì§€ëŠ” ì´ì „ì— ì •ì˜í•œ ìš”ì²­ ë©”ì‹œì§€ íƒ€ì…ì„ ë”°ë¦…ë‹ˆë‹¤. í•´ë‹¹ ì½œë°±ì˜ ë°˜í™˜ê°’ì€ ì‘ë‹µ ë©”ì‹œì§€ê°€ ë˜ë©°, í•„ìˆ˜ì ìœ¼ë¡œ ì‘ë‹µ ë©”ì‹œì§€ë¥¼ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤.

ì•±ì˜ ê²½ìš° ì•„ë˜ì™€ ê°™ì´ ì‚¬ìš©í•˜ë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤.

<pre>
  <code class="tsx">
    // ì•±ì—ì„œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ë•Œ

    const { ref, postMessage } = usePostMessageBridge<RequestMessage, ResponseMessage>();

    postMessage({
      message: {
        // ì „ì†¡í•  ìš”ì²­ ë©”ì‹œì§€
        // ì´ì „ì— ì •ì˜í•œ ìš”ì²­ ë©”ì‹œì§€ íƒ€ì…ì„ ë”°ë¥¸ë‹¤.
      },
    });

    return (
      <WebviewWithBridge
        ref={ref}
        //...
      />
    );
  </code>
</pre>

- usePostMessageBridge í›…ì„ í†µí•´ì„œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆëŠ” postMessage í•¨ìˆ˜ì™€ refë¥¼ ì–»ì–´ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- usePostMessageBridge í›…ì— ìš”ì²­ê³¼ ì‘ë‹µ ë©”ì‹œì§€ íƒ€ì…ì„ ì œë„¤ë¦­ìœ¼ë¡œ ë„˜ê²¨ì£¼ì–´, ìš”ì²­ê³¼ ì‘ë‹µ ë©”ì‹œì§€ì˜ íƒ€ì…ì„ ë¯¸ë¦¬ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- postMessage í•¨ìˆ˜ì˜ ê²½ìš° ë³´ë‚¼ ìš”ì²­ ë©”ì‹œì§€ë¥¼ ì¸ìë¡œ ë°›ìŠµë‹ˆë‹¤. ìš”ì²­ ë©”ì‹œì§€ëŠ” ì´ì „ì— ì •ì˜í•œ ìš”ì²­ ë©”ì‹œì§€ íƒ€ì…ì„ ë”°ë¦…ë‹ˆë‹¤.
- refëŠ” Webview ì»´í¬ë„ŒíŠ¸ì— ì „ë‹¬í•´ì£¼ì…”ì•¼ í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ì„œ Webview ì»´í¬ë„ŒíŠ¸ì—ì„œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<pre>
  <code class="jsx">
    // ì•±ì—ì„œ ë©”ì‹œì§€ë¥¼ ë°›ì„ ë•Œ 
    <WebviewWithBridge<MessageEventRequestData, MessageEventResponseData>
      ref={webViewRef}
      onBridgeMessage={(reqMessage) => {
        // ìš”ì²­ ë©”ì‹œì§€ë¥¼ ë°›ì•˜ì„ ë•Œ ì²˜ë¦¬í•˜ëŠ” ì½œë°±
        // reqMessageëŠ” ì´ì „ì— ì •ì˜í•œ ìš”ì²­ ë©”ì‹œì§€ íƒ€ì…ì„ ë”°ë¥¸ë‹¤.
        if (/*reqMessage ê´€ë ¨ ë¶„ê¸° ì²˜ë¦¬*/)
          return {
            // ì‘ë‹µ ë©”ì‹œì§€
          } 
        return {
          // ì˜ˆìƒí•˜ì§€ ëª»í•œ ìš”ì²­ì´ ì™”ì„ ë•Œì˜ ì‘ë‹µ ë©”ì‹œì§€
        };
      }}
      middleware={(reqMessage: MessageEventRequestData) => {
        // ìš”ì²­ ë©”ì‹œì§€ì— ëŒ€í•œ ë¯¸ë“¤ì›¨ì–´ ì²˜ë¦¬. ì´ëŠ” ì–´ë–¤ ìš”ì²­ ë©”ì‹œì§€ê°€ ì˜¤ë”ë¼ë„ onBridgeMessage ì½œë°±ì´ í˜¸ì¶œë˜ê¸° ì „ì— ì‹¤í–‰ëœë‹¤.
        // ì˜ˆë¥¼ ë“¤ì–´, ìš”ì²­ ë©”ì‹œì§€ì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•˜ê±°ë‚˜, ë¡œê¹… ë“±ì„ í•  ìˆ˜ ìˆë‹¤.
      }}
      //...
    />
  </code>
</pre>

- WebviewWithBridge ì»´í¬ë„ŒíŠ¸ì— ìš”ì²­ê³¼ ì‘ë‹µ ë©”ì‹œì§€ íƒ€ì…ì„ ì œë„¤ë¦­ìœ¼ë¡œ ë„˜ê²¨ì£¼ì–´, ìš”ì²­ê³¼ ì‘ë‹µ ë©”ì‹œì§€ì˜ íƒ€ì…ì„ ë¯¸ë¦¬ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- onBridgeMessage ì½œë°±ì„ í†µí•´ì„œ ìš”ì²­ ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìš”ì²­ ë©”ì‹œì§€ëŠ” ì´ì „ì— ì •ì˜í•œ ìš”ì²­ ë©”ì‹œì§€ íƒ€ì…ì„ ë”°ë¦…ë‹ˆë‹¤. í•´ë‹¹ ì½œë°±ì˜ ë°˜í™˜ê°’ì€ ì‘ë‹µ ë©”ì‹œì§€ê°€ ë˜ë©°, í•„ìˆ˜ì ìœ¼ë¡œ ì‘ë‹µ ë©”ì‹œì§€ë¥¼ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤.

ì—¬ê¸°ì„œ ì›¹ì€ ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ì½œë°±ìœ¼ë¡œ ë°›ëŠ” ë°˜ë©´, ì•±ì€ ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ë°˜í™˜ê°’ìœ¼ë¡œ ë°›ëŠ”ë‹¤ëŠ” ì°¨ì´ê°€ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” Webview ì»´í¬ë„ŒíŠ¸ì˜ refë¡œëŠ” ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ëŠ” êµ¬ì¡°ì´ê¸° ë•Œë¬¸ì— ë¶ˆê°€í”¼í•˜ê²Œ ëª¨ë“  ì‘ë‹µ í˜¹ì€ ìš”ì²­ì€ WebviewWithBridge ì»´í¬ë„ŒíŠ¸ë¡œ ë°›ì•„ì•¼ë§Œ í•©ë‹ˆë‹¤. 

### ìš”ì²­ê³¼ ì‘ë‹µ

ì´ì™€ ë”ë¶ˆì–´ì„œ ë³´ë‚¸ ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ë°›ì„ ìˆ˜ ìˆë„ë¡ í•´ì•¼ í–ˆìŠµë‹ˆë‹¤. ë‹¨ë°©í–¥ì¸ ì´ë²¤íŠ¸ ê¸°ë°˜ì˜ í†µì‹ ì—ì„œ, ë°›ëŠ” ê°’ì´ ìš”ì²­ì¸ì§€ ì‘ë‹µì¸ì§€ë¥¼ êµ¬ë¶„í•  ìˆ˜ ìˆì–´ì•¼ë§Œ í–ˆê³ , ì‘ë‹µì´ë¼ë©´ ì–´ë–¤ ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì¸ì§€ë¥¼ êµ¬ë¶„í•´ì•¼ë§Œ í–ˆìŠµë‹ˆë‹¤. ì´ë¥¼ êµ¬ë¶„í•˜ê¸° ìœ„í•˜ì—¬ ì¡°ê¸ˆ ë” ëª…í™•í•˜ê²Œ ë©”ì‹œì§€ íƒ€ì…ì„ ì •ì˜í•˜ë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤. 

- ê´€ë ¨ pr : https://github.com/JNU-econovation/Soop-APP/pull/33

ë©”ì‹œì§€ íƒ€ì…ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤. 

<pre>
  <code class="tsx">
    {
      _id : string // ë©”ì‹œì§€ë³„ë¡œ ê³ ìœ í•œ ì‹ë³„ì
      ack : string | null // í•´ë‹¹ ë©”ì‹œì§€ê°€ ìš”ì²­ì¸ ê²½ìš° null, ì‘ë‹µì¸ ê²½ìš° ìš”ì²­ ë©”ì‹œì§€ì˜ _idê°’
      flag : { syn } // í•´ë‹¹ ë©”ì‹œì§€ê°€ ì—°ê²° ìš”ì²­ ë©”ì‹œì§€ì¸ì§€ í‘œì‹œí•˜ëŠ” ê°’. ì´ëŠ” í•¸ë“œì…°ì´í¬ ê³¼ì •ì—ì„œ ì‚¬ìš©
      body : any // ë©”ì‹œì§€ ë³¸ë¬¸ê°’. ì´ëŠ” ìƒë‹¨ì—ì„œ ë‚´ë ¤ì¤€ ë©”ì‹œì§€ê°€ ë‹´ê¹€
    }
  </code>
</pre>

ëª¨ë“  ë©”ì‹œì§€ëŠ” ê³ ìœ í•œ ì‹ë³„ì idë¥¼ ê°€ì§‘ë‹ˆë‹¤. ìš”ì²­ì´ë¼ë©´ ackê°’ì´ nullì´ê³ , ì‘ë‹µì´ë¼ë©´ ackê°’ì´ ìš”ì²­ ë©”ì‹œì§€ì˜ _idê°’ì´ ë˜ë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ì„œ ìš”ì²­ê³¼ ì‘ë‹µì„ êµ¬ë¶„í•  ìˆ˜ ìˆê³ , ì–´ë–¤ ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì¸ì§€ë¥¼ íŠ¹ì •ì§€ì„ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. 

### ë©”ì‹œì§€ í

ì´ì œ ë©”ì‹œì§€ì˜ í˜•ì‹ì´ ì •í•´ì¡Œê³ , ìš”ì²­ê³¼ ì‘ë‹µì„ ì£¼ê³  ë°›ì„ ìˆ˜ ìˆê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. 
ì´ì œëŠ” ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ìª½ì—ì„œ ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ë°›ì•„ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•´ì•¼ í–ˆìŠµë‹ˆë‹¤. 
ì‘ë‹µì€ ìš”ì²­ì„ ë³´ë‚¸ ì¦‰ì‹œ ì˜¤ì§€ ì•ŠëŠ” ë¹„ë™ê¸° ë°©ì‹ìœ¼ë¡œ ë™ì‘í•˜ê¸° ë•Œë¬¸ì—, ìš”ì²­ì„ ë³´ë‚¼ ë•Œë§ˆë‹¤ ì‘ë‹µì„ ì²˜ë¦¬í•  ì½œë°±ì„ ë¯¸ë¦¬ ì €ì¥í•´ë‘ê³ , ì‘ë‹µì´ ì™”ì„ ë•Œ í•´ë‹¹ ì½œë°±ì„ ì°¾ì•„ í˜¸ì¶œí•´ì•¼ë§Œ í–ˆìŠµë‹ˆë‹¤.
ì´ë¥¼ ìœ„í•´ì„œ ë©”ì‹œì§€ íë¥¼ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤.
ìš”ì²­ì„ ë³´ë‚¼ ë•Œë§ˆë‹¤ ë©”ì‹œì§€ íì— ìš”ì²­ ë©”ì‹œì§€ì˜ _idì™€ ì‘ë‹µ ì½œë°±ì„ ì €ì¥í•´ë‘ê³ , ì‘ë‹µ ë©”ì‹œì§€ë¥¼ ë°›ì•˜ì„ ë•Œ ë©”ì‹œì§€ íì—ì„œ í•´ë‹¹ _idì— ëŒ€í•œ ì½œë°±ì„ ì°¾ì•„ í˜¸ì¶œí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤.

íì˜ ì´ë¦„ì€ TCP í†µì‹ ì—ì„œ íë¦„ ì œì–´ë¥¼ ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ìˆ˜ì‹  ìœˆë„ìš°(RWND, Receive Window)ì—ì„œ ë”°ì™”ìŠµë‹ˆë‹¤.

<pre>
  <code class="tsx">
    class RWindow {
      // TODO: ë‹¨ìˆœ idë¥¼ ë‹´ëŠ” ê²ƒì´ ì•„ë‹Œ ê°ì²´ë¡œ ë³€ê²½ ê³ ë ¤ (ë©”ì‹œì§€ bodyë¥¼ ì œì™¸í•œ ëª¨ë“  ì •ë³´ ë‹´ê¸°)
      public RWND_BUFFER: Set&lt;string&gt;;

      //TODO: WeakMapìœ¼ë¡œ ë³€ê²½ ê³ ë ¤ =&gt; RWND_BUFFERì—ì„œ ê°ì²´ë¥¼ ì œê±°í•˜ë©´ GCê°€ ì½œë°±ë„ ì œê±°í•´ì¤„ ê²ƒì„
      private callbackBuffer: Map&lt;string, ((resMessage?: any) =&gt; void)[]&gt; =
        new Map();
      private static WINDOW_SIZE = 20;

      constructor() {
        this.RWND_BUFFER = new Set&lt;string&gt;();
      }

      // id ì¶”ê°€
      public add(id: string) {
        if (this.RWND_BUFFER.size &gt;= RWindow.WINDOW_SIZE) {
          throw new Error("RWND_BUFFER is already full");
        }

        if (this.RWND_BUFFER.has(id)) {
          throw new Error("RWND_BUFFER already contains this id");
        }

        this.RWND_BUFFER.add(id);
      }

      // idì— í•´ë‹¹í•˜ëŠ” ì½œë°±ë“¤ ì œê±° ë° ë°˜í™˜
      public popCallbacksById(id: string) {
        this.RWND_BUFFER.delete(id);

        const callbacks = this.callbackBuffer.get(id);
        this.callbackBuffer.delete(id);

        return callbacks ?? [];
      }
      
      // idì— ì½œë°± ì¶”ê°€
      public addListener&lt;ResMessageType&gt;(
        id: string,
        callback: (resMessage: ResMessageType) =&gt; void,
      ) {
        if (this.callbackBuffer.has(id)) {
          this.callbackBuffer.set(id, [...this.callbackBuffer.get(id)!, callback]);
          return;
        }
        this.callbackBuffer.set(id, [callback]);
      }

      // idì— í•´ë‹¹í•˜ëŠ” ì½œë°±ë“¤ ë°˜í™˜
      public getListeners(
        id: string,
      ): ((resMessage?: unknown) =&gt; void)[] | undefined {
        return this.callbackBuffer.get(id);
      }
    }
  </code>
</pre>


RWindow ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì „ì—­ìœ¼ë¡œ ìƒì„±í•˜ì—¬ idì™€ ì½œë°±ì„ ê´€ë¦¬í•˜ë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤. ìš”ì²­ì„ ë³´ë‚¼ ë•Œë§ˆë‹¤ RWindow ì¸ìŠ¤í„´ìŠ¤ì— idê°’ê³¼ ì½œë°±ì„ ì €ì¥í•˜ë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤. 

ì´í›„ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆëŠ” ë™ì‘ì„ ì •ì˜í•´ë³´ì•˜ìŠµë‹ˆë‹¤. 

<pre>
  <code class="tsx">
    class Message&lt;BodyType = unknown&gt; {
      private _id: string;
      private ack: string | null;
      private flag: { syn: 0 | 1 };
      private body?: BodyType;

      constructor(
        private ref: React.RefObject&lt;WebView&lt;{}&gt; | null&gt;,
        private R_WND: RWindow,
        {
          ack = null,
          syn = 0,
          body,
        }: {
          syn: 0 | 1;
          ack: string | null;
          body?: BodyType;
        },
      ) {
        this._id = this.getRandomId();
        this.ack = ack;
        this.flag = { syn };
        this.body = body;
      }

      private createNewMessageObj = () =&gt; {
        return {
          _id: this._id,
          ack: this.ack,
          flag: this.flag,
          body: this.body,
        };
      };

      // ë©”ì‹œì§€ ì „ì†¡ ë° ì½œë°± ë“±ë¡
      public send = &lt;ResMessageType&gt;(callback?: (m: ResMessageType) =&gt; void) =&gt; {
        Message.sendWebviewMessage(this.ref, this.createNewMessageObj());

        if (!callback) return;
        this.R_WND.addListener(this._id, callback);
      };

      // ì›¹ì˜ ê²½ìš° ì•„ë˜ì˜ ë°©ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì˜€ë‹¤. 
      // ìš”ì²­ì„ ë³´ë‚´ë©´ ì‘ë‹µ ì½œë°±ì„ ë“±ë¡í•˜ê³ , windowì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë“±ë¡í•˜ì—¬ ì‘ë‹µ ë©”ì‹œì§€ë¥¼ ë°›ëŠ”ë‹¤.
      // ì‘ë‹µ ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ë©´(ackê°€ _idì™€ ì¼ì¹˜), í•´ë‹¹ ì½œë°±ì„ ì°¾ì•„ í˜¸ì¶œí•˜ê³ , ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì œê±°í•œë‹¤.
      public send = &lt;Body&gt;(callback?: (m: WebviewBridgeMessage&lt;Body&gt;) =&gt; void) =&gt; {
        Message.sendWebviewMessage(this.createNewMessageObj());

        if (!callback) return;
        this.R_WND.addListener(this._id, callback);

        const messageHandler = (event: Event) =&gt; {
          const messageEvent = event as MessageEvent&lt;WebviewBridgeMessage&lt;Body&gt;&gt;;
          messageEvent.stopPropagation();
          const resMessage =
            typeof messageEvent.data === "string"
              ? (JSON.parse(messageEvent.data) as WebviewBridgeMessage&lt;Body&gt;)
              : messageEvent.data;

          if (resMessage.ack === this._id) {
            const listeners = this.R_WND.popCallbacksById(this._id);
            listeners.forEach((listener) =&gt; listener(resMessage));
            document.removeEventListener("message", messageHandler);
            window.removeEventListener("message", messageHandler);
          }
        };

        document.addEventListener("message", messageHandler as EventListener);
        window.addEventListener("message", messageHandler);
      };
    }
  </code>
</pre>

ì´ë¥¼ í•œë²ˆì— ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” í´ë˜ìŠ¤ë„ ë§Œë“¤ì–´ ë³´ì•˜ìŠµë‹ˆë‹¤. 

<pre>
  <code class="tsx">
    class WebViewBridge {
      private R_WND: RWindow = new RWindow();

      public createMessage = &lt;BodyType&gt;(
        // WebView refì™€ ë©”ì‹œì§€ bodyë¥¼ ì¸ìë¡œ ë°›ì•„ ë©”ì‹œì§€ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±. 
        // ì•±ì—ì„œë§Œ ìœ íš¨í•˜ë©°, ì›¹ì—ì„œëŠ” refë¥¼ ë°›ì§€ ì•ŠëŠ”ë‹¤.
        ref: React.RefObject&lt;WebView | null&gt;,
        {
          ack = null,
          syn = 0,
          body,
        }: Omit&lt;WebviewBridgeMessage&lt;BodyType&gt;, "flag" | "_id"&gt; &amp; {
          syn?: Flag;
        },
      ) =&gt; {
        return new Message&lt;BodyType&gt;(ref, this.R_WND, {
          ack,
          syn,
          body,
        });
      };

      // idì— í•´ë‹¹í•˜ëŠ” ì½œë°±ì„ ì°¾ì•„ í˜¸ì¶œ
      public renderCallback = (ack: string, body: unknown) =&gt; {
        const callbacks = this.RWND.popCallbacksById(ack);

        callbacks.forEach((callback) =&gt; callback(body));
      };
    }

    // ì‚¬ìš©ë²•
    const Bridge = new WebViewBridge();
    Bridge.createMessage(webViewRef, {
      syn: ...,
      ack: ...,
      body: { ... },
    }).send(() =&gt; {/* callback */});
  </code>
</pre>

ìœ„ì˜ 3ê°œì˜ í´ë˜ìŠ¤ë¥¼ í†µí•´ì„œ ë©”ì‹œì§€ë¥¼ ì£¼ê³  ë°›ì„ ìˆ˜ ìˆëŠ” ê¸°ë³¸ì ì¸ êµ¬ì¡°ë¥¼ ì™„ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.

ì´ì œ ì´ë¥¼ react í›…ê³¼ ì»´í¬ë„ŒíŠ¸ë¡œ ê°ì‹¸ì„œ ê°œë°œ ë‹¨ê³„ì—ì„œ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤.

### ë¦¬ì•¡íŠ¸ í›…ê³¼ ì»´í¬ë„ŒíŠ¸ë¡œ ê°ì‹¸ê¸°

ì•±ì—ì„œ ë³´ë‚¼ ë•Œì—ëŠ” usePostMessageBridge í›…ì„ ì‚¬ìš©í•˜ë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤. 

<pre>
  <code class="tsx">
    interface PostMessageProps&lt;MessageType, ResponseType&gt; {
      message: MessageType;
      onResponse?: (response: ResponseType) =&gt; void;
    }

    const usePostMessageBridge = &lt;ReqType, ResponseType&gt;() =&gt; {
      const ref = useRef&lt;WebView | null&gt;(null);

      const postMessage = ({
        message,
        onResponse,
      }: PostMessageProps&lt;ReqType, ResponseType&gt;) =&gt; {
        if (!ref.current) {
          // WebViewê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš°
          // ...
          return;
        }

        try {
          // ìš”ì²­ ë©”ì‹œì§€ ìƒì„± ë° ì „ì†¡
          const newMessage = Bridge.createMessage&lt;ReqType&gt;(ref, {
            ack: null,
            body: message,
          });
          newMessage.send&lt;ResponseType&gt;((response) =&gt; {
            if (onResponse) return onResponse(response);
          });
        } catch (error) {
          // ...
        }
      };

      return {
        ref,
        postMessage,
      };
    };
  </code>
</pre>

ì›¹ì—ì„œëŠ” ì•„ë˜ì™€ ê°™ì´ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤. 

<pre>
  <code class="tsx">
    "use client";
    interface RequestProps&lt;ReqBody = unknown, ResBody = unknown&gt; {
      requestMessage: ReqBody;
      responseCallback?: (resMessage: ResBody) =&gt; void;
    }

    const useBridge = &lt;ReqBody = unknown, ResBody = unknown&gt;() =&gt; {
      const Bridge = getBridge();
      const [isReady, setIsReady] = useState(false); // ì›¹ë·°ê°€ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€

      // ì›¹ë·°ê°€ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í•¸ë“œì…°ì´í¬ ë©”ì‹œì§€ ì „ì†¡.
      const sendHandshakeSynMessage = useCallback(() =&gt; {
        if (isReady) return;
        Bridge.createMessage({
          syn: BRIDGE.SET,
          ack: null,
        }).send((message) =&gt; { // ì•±ìœ¼ë¡œë¶€í„° syn/ack ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ë©´ ack ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³ , ì›¹ë·°ê°€ ì¤€ë¹„ë˜ì—ˆìŒì„ ì¸ì§€
          const {
            _id,
            ack,
            flag: { syn },
          } = message;
          if (syn !== BRIDGE.SET) // error...
          if (ack === null) // error...
          setIsReady(true); // ì•±ìœ¼ë¡œë¶€í„° syn/ack ë©”ì‹œì§€ë¥¼ ë°›ì•˜ìœ¼ë¯€ë¡œ, ì•±ì´ ì›¹ë·° í†µì‹  ì¤€ë¹„ê°€ ë˜ì—ˆìŒì„ ì¸ì§€

          // ack ë©”ì‹œì§€ ì „ì†¡ (í•¸ë“œì…°ì´í¬ ì™„ë£Œ)
          Bridge.createMessage({
            ack: _id,
            syn: BRIDGE.RESET,
          }).send();
        });
      }, [Bridge, isReady]);

      // ì»´í¬ë„ŒíŠ¸ê°€ ë§ˆìš´íŠ¸ë  ë•Œ í•¸ë“œì…°ì´í¬ ì‹œì‘
      useEffect(() =&gt; {
        sendHandshakeSynMessage();
      }, [sendHandshakeSynMessage]);

      // ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆëŠ” request í•¨ìˆ˜
      const request = ({
        requestMessage,
        responseCallback,
      }: RequestProps&lt;ReqBody, ResBody&gt;) =&gt; {
        // ì„œë²„ì—ì„œ ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ ë°©ì§€
        if (typeof window === "undefined") return;

        // ì…ë ¥ë°›ì€ ìš”ì²­ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ê³  ì‘ë‹µ ì½œë°± ë“±ë¡
        Bridge.createMessage({
          ack: BRIDGE.BLANK,
          body: requestMessage,
        }).send&lt;ResBody&gt;(({ body }) =&gt; {
          if (responseCallback &amp;&amp; body) return responseCallback(body);
        });
      };

      return { request };
    };
  </code>
</pre>

ì‘ë‹µì„ ë°›ëŠ” ì•± ì»´í¬ë„ŒíŠ¸ëŠ” ì•„ë˜ì™€ ê°™ì´ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤. 

<pre>
  <code class="tsx">
    interface WebViewWithBridgeProps&lt;ReqMessage, ResMessage&gt;
      extends Omit&lt;ComponentProps&lt;typeof WebView&gt;, "onMessage"&gt; {
      onBridgeMessage?:
        | ((reqMessage: ReqMessage) =&gt; ResMessage | void)
        | ((reqMessage: ReqMessage) =&gt; Promise&lt;ResMessage | void&gt;);
      onReadyToMessage?: () =&gt; void;
      middleware?: (message: ReqMessage) =&gt; void;
      ref?: Ref&lt;WebView&gt;;
    }

    const WebviewWithBridge = &lt;ReqMessage, ResMessage&gt;({
      onBridgeMessage,
      onReadyToMessage,
      middleware,
      ref,
      ...props
    }: WebViewWithBridgeProps&lt;ReqMessage, ResMessage&gt;) =&gt; {
      const [isReady, setIsReady] = useState(false); // ì›¹ë·°ê°€ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€
      const internalRef = useRef&lt;WebView&gt;(null);
      const webViewRef = ref ? (ref as React.RefObject&lt;WebView&gt;) : internalRef;

      const handleMessage = useCallback(
        (event: WebViewMessageEvent) =&gt; {
          const reqMessage = JSON.parse(
            event.nativeEvent.data,
          ) as WebviewBridgeMessage&lt;ReqMessage&gt;;

          const {
            _id,
            ack,
            flag: { syn },
            body,
          } = reqMessage;

          // ë§Œì•½ ìˆ˜ì‹ í•œ ë©”ì‹œì§€ê°€ ack ë©”ì‹œì§€ë¼ë©´(íŠ¹ì • ìš”ì²­ ë©”ì‹œì§€ì— ëŒ€í•œ ì‘ë‹µ ë©”ì‹œì§€ë¼ë©´), í•´ë‹¹ ì½œë°±ì„ ì°¾ì•„ í˜¸ì¶œ
          if (ack) Bridge.renderCallback(ack, reqMessage);

          // handshake ë¡œì§
          // ì›¹ìœ¼ë¡œë¶€í„° handshake sync ë©”ì‹œì§€ ìˆ˜ì‹ 
          if (!isReady) {
            if (!isReady &amp;&amp; syn === 1 &amp;&amp; ack === null) {
              // ì›¹ì—ì„œ synì„ ë³´ëƒˆì„ ë•Œ, syn/ackì„ ë³´ë‚´ì¤€ë‹¤.
              Bridge.createMessage(webViewRef, {
                syn: 1,
                ack: _id,
              }).send&lt;WebviewHandshake&gt;(({ ack, flag: { syn } }) =&gt; {
                if (!isReady &amp;&amp; syn === 0 &amp;&amp; ack !== null) {
                  setIsReady(true);
                  return;
                }
              });
              return;
            }
          }

          // ì›¹ë·°ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì€ ìƒíƒœë¼ë©´ ì¼ë°˜ì ì¸ ë©”ì‹œì§€ ì²˜ë¦¬ë¥¼ í•˜ì§€ ì•ŠìŒ
          if (!isReady) return;

          // ì¼ë°˜ì ì¸ ë©”ì‹œì§€ ì²˜ë¦¬
          if (onBridgeMessage) {
            const resMessage = onBridgeMessage(body);

            // onBridgeMessageê°€ Promiseë¥¼ ë°˜í™˜í•˜ëŠ” ê²½ìš°
            if (resMessage instanceof Promise) {
              resMessage
                .then((response) =&gt; {
                  if (!response) {
                    // ì‘ë‹µì´ ì—†ëŠ” ê²½ìš° ê²½ê³  ë˜ëŠ” ì—ëŸ¬ ì²˜ë¦¬
                  }
                  // ì‘ë‹µ ë©”ì‹œì§€ ì „ì†¡
                  Bridge.createMessage(webViewRef, {
                    ack: _id,
                    body: response,
                  }).send();
                })
                .catch((error) =&gt; {
                  // ...
                });
              return;
            } else {
              // onBridgeMessageê°€ ì¼ë°˜ ê°’ì„ ë°˜í™˜í•˜ëŠ” ê²½ìš°
              if (!resMessage) {
                // ì‘ë‹µì´ ì—†ëŠ” ê²½ìš° ê²½ê³  ë˜ëŠ” ì—ëŸ¬ ì²˜ë¦¬
              }
              // ì‘ë‹µ ë©”ì‹œì§€ ì „ì†¡
              Bridge.createMessage(webViewRef, {
                ack: _id,
                body: resMessage,
              }).send();
            }
          }
        },
        [onBridgeMessage, middleware, isReady],
      );

      return &lt;WebView ref={webViewRef} onMessage={handleMessage} {...props} /&gt;;
    };
  </code>
</pre>

ì›¹ì—ì„œëŠ” ì•„ë˜ì™€ ê°™ì´ ì‘ì„±í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

<pre>
  <code class="tsx">
    "use client";

    interface BridgeProps&lt;RequestMessage, ResponseMessage&gt; {
      onRequest: (reqMessage: RequestMessage) =&gt; ResponseMessage;
      requestValidator?: (reqMessage?: RequestMessage) =&gt; boolean;
    }

    export default function BridgeRequestListener&lt;RequestType, ResponseType&gt;({
      onRequest,
      requestValidator,
    }: BridgeProps&lt;RequestType, ResponseType&gt;) {
      const Bridge = getBridge();
      const [isReady, setIsReady] = useState(false); // ì›¹ë·°ê°€ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€

      // í•¸ë“œì…°ì´í¬ ë©”ì‹œì§€ ì „ì†¡ ë¡œì§
      const sendHandshakeSynMessage = useCallback(() =&gt; {
        if (isReady) return;

        // ì•±ìœ¼ë¡œ syn ë©”ì‹œì§€ ì „ì†¡. ì˜¬ë°”ë¥¸ ì‘ë‹µì„ ë°›ìœ¼ë©´ ack ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³ , ì›¹ë·°ê°€ ì¤€ë¹„ë˜ì—ˆìŒì„ ì¸ì§€
        Bridge.createMessage({
          syn: BRIDGE.SET,
          ack: null,
        }).send((message) =&gt; {
          const {
            _id,
            ack,
            flag: { syn },
          } = message;
          
          // ì˜¬ë°”ë¥¸ ì‘ë‹µì´ë¼ë©´ 
          setIsReady(true); // ì•±ì´ ì›¹ë·° í†µì‹  ì¤€ë¹„ê°€ ë˜ì—ˆìŒì„ ì¸ì§€

          // ack ë©”ì‹œì§€ ì „ì†¡ (í•¸ë“œì…°ì´í¬ ì™„ë£Œ)
          Bridge.createMessage({
            ack: _id,
            syn: BRIDGE.RESET,
          }).send();
        });
      }, [Bridge, isReady]);

      // ì›¹ë·°ì˜ ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ë¡œì§. ì•±ìœ¼ë¡œë¶€í„° ìš”ì²­ì„ ë°›ì•˜ì„ ë•Œ ì‹¤í–‰ëœë‹¤.
      useEffect(() =&gt; {
        if (!isReady) return;

        const handleMessage = (event: Event) =&gt; {
          const messageEvent = event as MessageEvent;

          const { data } = messageEvent;
          try {
            const {
              ack,
              _id,
              flag: { syn },
              body,
            } = typeof data === "string"
              ? (JSON.parse(data) as WebviewBridgeMessage&lt;RequestType&gt;)
              : (data as WebviewBridgeMessage&lt;RequestType&gt;);

            if (ack !== null)
              throw new Error(
                "í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë³´ë‚¸ ìš”ì²­ì— ackê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.",
              );

            if (syn === 1)
              throw new Error(
                "í•¸ë“œì…°ì´í¬ê°€ ëë‚œ ì‹œì ì—ì„œ ì›¹ë·° í•¸ë“œì…°ì´í¬ ë©”ì‹œì§€ê°€ ë„ì°©í•˜ì˜€ìŠµë‹ˆë‹¤.",
              );

            if (requestValidator &amp;&amp; !requestValidator(body)) {
              throw new Error(
                "ìš”ì²­ ë©”ì‹œì§€ì˜ ìœ íš¨ì„± ê²€ì‚¬ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ìš”ì²­ ë©”ì‹œì§€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.",
              );
            }

            if (body) {
              const responseMessage = onRequest(body);

              if (strictMode &amp;&amp; !responseMessage)
                throw new Error("ì‘ë‹µ ë©”ì‹œì§€ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");

              Bridge.createMessage({
                ack: _id,
                syn: BRIDGE.RESET,
                body: responseMessage,
              }).send();
            }
          } catch (error) {
            console.error("ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
          }
        };

        // ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ë¡œì§
        if (Message.checkIsAndroid()) {
          document.addEventListener("message", handleMessage as EventListener);
          return () =&gt;
            document.removeEventListener("message", handleMessage as EventListener);
        } else {
          window.addEventListener("message", handleMessage);
          return () =&gt; window.removeEventListener("message", handleMessage);
        }
      }, [Bridge, isReady, onRequest, requestValidator, strictMode]);

      // ì›¹ë·° í•¸ë“œì…°ì´í¬ë¥¼ ìœ„í•œ ë¡œì§
      useEffect(() =&gt; {
        sendHandshakeSynMessage();
      }, [sendHandshakeSynMessage]);

      return null;
    }
  </code>
</pre>

### ì‹¤ì œ ì‚¬ìš© ëª¨ìŠµ

ì›¹ë·°ë¥¼ ì‚¬ìš©í•˜ì˜€ì„ ë•Œ, ì›¹ì˜ ê¸°ë³¸ í™”ë©´ ì „í™˜(ë„¤ë¹„ê²Œì´ì…˜)ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ íˆ­íˆ­ ëŠê¸°ê³  ë¶€ë“œëŸ½ì§€ ëª»í•œ í™”ë©´ ì „í™˜ì´ ë°œìƒí•©ë‹ˆë‹¤. ì´ë¡œ ì¸í•´ í˜„ì¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ëª¨ë“  ë„¤ë¹„ê²Œì´ì…˜(í™”ë©´ ì „í™˜)ì˜ ì±…ì„ì„ ì•±ì—ì„œ ë‹´ë‹¹í•˜ë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³ , ì›¹ì—ì„œ íŠ¹ì • ì¸í„°ë™ì…˜ ë°œìƒ ì‹œ íŠ¹ì • í˜ì´ì§€ë¡œ í™”ë©´ì„ ì „í™˜í•˜ë„ë¡ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤. 

![ì›¹ë·°ì‹œì—°](https://github.com/geongyu09/geongyu09.github.io/blob/dev/public/assets/blog/webviewThreeWayHandshake/%EC%9B%B9%EB%B7%B0%EC%8B%9C%EC%97%B0.gif?raw=true)

ì‚¬ì§„ê³¼ ê°™ì´ í†µì‹ ì„ í†µí•œ ì›¹ë·°ì—ì„œì˜ í™”ë©´ ì „í™˜ì´ ì˜ ë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤!!!

ì„¤ëª…ì„ ìœ„í•´ì„œ ë§ì€ ì½”ë“œê°€ ìƒëµë˜ì—ˆìŠµë‹ˆë‹¤. ì „ì²´ ì½”ë“œëŠ” [ì—¬ê¸°](https://github.com/JNU-econovation/Sangyeol-FE/tree/develop/packages/bridge)ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

### ë§ˆë¬´ë¦¬

ì´ë ‡ê²Œ í•´ì„œ ì›¹ë·°ì™€ ì•± ê°„ì˜ ì–‘ë°©í–¥ í†µì‹ ì„ ì•ˆì „í•˜ê²Œ í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°ë¥¼ ì™„ì„±í•˜ì˜€ìŠµë‹ˆë‹¤. ë­”ê°€ ê°œë°œí•˜ë©´ì„œ ì œ ìŠ¤ìŠ¤ë¡œ ë¬¸ì œì ì„ ì¸ì‹í•˜ê³ , ì´ë¥¼ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬(?)ë¥¼ ë§Œë“¤ì–´ ê°„ ì ì—ì„œ ì§„ì§œ ê°œë°œìê°€ ëœ ëŠë‚Œì´ ë“¤ì—ˆìŠµë‹ˆë‹¤. ë¬¼ë¡  ì•„ì§ë„ ë¶€ì¡±í•œ ì ì´ ë§ê³ , ê°œì„ í•  ì ì´ ë§ì€ ì½”ë“œì´ì§€ë§Œ, ê¸°ë³¸ì ì¸ êµ¬ì¡°ë¥¼ ì™„ì„±í–ˆë‹¤ëŠ” ì ì—ì„œ ë¿Œë“¯í•©ë‹ˆë‹¤.

ì ì°¨ ë¶€ì¡±í•œ ì½”ë“œë“¤ë„ ê°œì„ í•´ ë‚˜ê°€ë©´ì„œ, ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë°œì „ì‹œì¼œ ë‚˜ê°€ê³  ì‹¶ìŠµë‹ˆë‹¤. ê¸°íšŒê°€ ëœë‹¤ë©´ ì˜¤í”ˆ ì†ŒìŠ¤ë¡œ ê³µê°œí•˜ì—¬, ë‹¤ë¥¸ ê°œë°œìë¶„ë“¤ë„ ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤..!!